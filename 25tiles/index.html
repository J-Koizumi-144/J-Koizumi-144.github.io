<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>25TILES</title>
<style>
  :root { --tile-size: 100px; --gap: 6px; --mini: 20px; }
  body {
    margin: 0; min-height: 100vh;
    display: grid; place-items: center;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto,
                 "Hiragino Sans", "Noto Sans JP", sans-serif;
    background: #f6f7f9;
  }
  main { text-align: center; width: min(680px, 96vw); }

  /* ヘッダー：お手本プレビューと状態表示 */
  .header {
    display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
    margin-bottom: 12px;
  }
  .preview-card {
    width: 112px;
    display: flex; align-items: center; gap: 12px;
    background: #ddd; border: 1px solid #e2e6ef; border-radius: 12px;
    padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,.06);
  }
  .preview-card .label { font-weight: 600; color: #394150; }
  .mini {
    display: grid; grid-template-columns: repeat(5, var(--mini)); gap: 3px;
  }
  .mini-tile {
    width: var(--mini); height: var(--mini);
    border-radius: 3px; background: #fff; border: none;
  }
  .mini-tile.black { background: #111;}
  .mini-tile.red { background: #5bc;}

  .status-area { text-align: right; }
  .status-text { font-weight: 600; color: #6b7280; font-size: 24px; }
  .btn {
    margin-left: .5rem; padding: .5rem .75rem;
    border-radius: 10px; border: 2px solid #333333; background: #fff;
    cursor: pointer; transition: transform .05s ease;
    color: #222;
  }
  .btn:active { transform: scale(.98); }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .btn.primary { background: #111; color: #fff; border-color: #111; }

  .board-wrap { background: #ddd; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08); padding: 16px; position: relative; }
  .board-wrap.cleared { background: rgb(249, 223, 146); }
  .board-wrap::before {
    content: "";
    position: absolute;
    left: 50%; top: 50%;
    width: 0; height: 0;
    border: 20px solid rgb(249, 223, 146); border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    pointer-events: none;
    z-index: 5;
  }
  
  .board-wrap.is-cleared::before {
    animation: ring-grow 400ms ease-out forwards;
  }

  @keyframes ring-grow {
    0%   { width: 100px; height: 100px; opacity: 1.0; }
    70%  { opacity: 0.8; }
    100% { width: 400px; height: 400px; opacity: 0; }
  }

  .board {
    display: grid;
    grid-template-columns: auto repeat(5, var(--tile-size));
    grid-template-rows: auto repeat(5, var(--tile-size));
    gap: var(--gap);
    align-items: center;
    justify-items: center;
    padding: 20px;
  }

  .tile {
    width: var(--tile-size); height: var(--tile-size);
    border-radius: 6px; background: #fff;
    transition: background-color .15s ease, box-shadow .15s ease;
  }
  .tile.black { background: #222;}
  .tile.red { background: #2bc;}

  .ctrl {
    width: 54px; height: 54px; border-radius: 50%; margin: 5px;
    border: none; background: #fff; cursor: pointer;
    display: grid; place-items: center; position: relative;
    transition: transform .05s ease, background .15s ease, border-color .15s ease;
  }
  .ctrl:active { transform: scale(.96); }

  /* オーバーレイ（タイトル/結果） */
  .overlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    padding: 24px; background: rgba(15,18,24,.5); z-index: 10;
  }
  .overlay.show { display: flex; }
  .modal {
    background: #fff; border: 1px solid #e6e8f0; border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15); width: min(560px, 92vw);
    padding: 24px; text-align: center;
  }
  .modal h1, .modal h2 { margin: 0 0 8px; color: #111827; }
  .modal p { margin: 4px 0 16px; color: #4b5563; }
  .modal .actions { display: flex; gap: 8px; justify-content: center; }

  @media (max-width: 480px) {
    :root { --tile-size: 44px; }
    .ctrl, .top-left { width: 30px; height: 30px; }
  }

  #timerText {
    display: inline-block;
    min-width: 100px; /* 必要な幅に合わせて調整 */
    text-align: left; /* または center */
  }

  #statusText {
    display: inline-block;
    min-width: 200px; /* 必要な幅に合わせて調整 */
    text-align: left; /* または center */
  }

  #resultText {
    font-size: 24px;
  }
  
  /*ダブルタップ対策*/
  html, body { touch-action: manipulation; }
  button, .ctrl { touch-action: manipulation; }

  #leaderboardTable {
    border-collapse: collapse;
    width: 100%;
  }

  #leaderboardTable th,
  #leaderboardTable td {
    padding: 4px 8px;
    text-align: left;
    border: none; /* 枠なし */
  }

  .form-group {
    display: flex;
    align-items: center;
    margin: 20px 0;
  }

  .form-group label {
    width: 140px;           /* ラベル幅を固定して左右を揃える */
    font-weight: 600;
  }

  .input {
    flex: 1;                /* 残りの幅いっぱいを入力欄に */
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
  }


</style>
</head>
<body>
<main>
  <div style="margin: 20%;"></div>
  <div class="header">
    <div class="preview-card">
      <div class="mini" id="targetPreview" aria-label="お手本プレビュー"></div>
    </div>
    <div class="status-area">
      <span id="statusText" class="status-text" aria-live="polite">SCORE: 0</span>
      <span id="timerText" class="status-text" aria-live="polite">30.0</span>
      <button id="newBtn" class="btn" type="button">NEXT</button>
      <button id="resetBtn" class="btn" type="button">RESET</button>
    </div>
  </div>

  <div class="board-wrap" id="boardWrap">
    <div class="board" id="board" aria-label="タイル盤">
      <div class="top-left" aria-hidden="true" style="width:36px;height:36px;"></div>
      <!-- 以降はJSで生成 -->
    </div>
  </div>

  <div style="margin: 20%;"></div>
</main>

<!-- タイトル画面 -->
<div id="titleScreen" class="overlay show" aria-modal="true" role="dialog">
  <div class="modal">
    <h1>25TILES</h1>
    <p>A random pattern will appear in the upper-left corner.</br>左上にランダムな模様が表示されます。</p>
    <p>Color rows and columns and recreate the pattern.</br>行や列に色を塗って同じ模様を作ってください。</p>
    <p>Pressing a button multiple times will cycle through the available colors.</br>ボタンを複数回押すと塗られる色が変わります。</p>
    <div class="actions">
      <button id="startBtn" class="btn primary" type="button">START</button>
      <button id="rankingBtn" class="btn" type="button">RANKING</button>
    </div>
  </div>
</div>

<!-- ロード画面 -->
<div id="loadScreen" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <h1>Loading...</h1>
  </div>
</div>

<!-- ランキング画面 -->
<div id="rankingScreen" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <h1>Ranking</h1>
    <div id="leaderboard">
      <table id="leaderboardTable" style="color: #555;">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="actions">
      <button id="rankingCloseBtn" class="btn" type="button">BACK</button>
    </div>
  </div>
</div>

<!-- 結果画面 -->
<div id="resultScreen" class="overlay" aria-modal="true" role="dialog" aria-hidden="true">
  <div class="modal">
    <h2>TIME'S UP!</h2>
    <p id="resultText"></p>
    <div style = "margin: 10px;">
      <button id="tweetBtn" class="btn" type="button">TWEET</button>
    </div>
    <div style = "margin: 10px;">
      <button id="scoreRegBtn" class="btn" type="button">SUBMIT SCORE</button>
    </div>
    <div class="actions">
      <button id="toTitleBtn" class="btn primary" type="button">BACK TO TITLE</button>
    </div>
  </div>
</div>

<!-- Score Registration Modal -->
<div id="scoreModal" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <h2>Score Registration</h2>
    <p>Please use the same User ID each time.</br>User IDは毎回同じものを用いてください。</p>
    <div class="form-group">
      <label for="regName">Name</label>
      <input type="text" id="regName" class="input" />
    </div>
    <div class="form-group">
      <label for="regID">User ID (private)</label>
      <input type="text" id="regID" class="input" />
    </div>
    <div class="actions">
      <button id="submitScoreBtn" class="btn primary" type="button">REGISTER</button>
      <button id="closeScoreModalBtn" class="btn" type="button">CANCEL</button>
    </div>
  </div>
</div>



<script>
(() => {
const N=5,DURATION_MS=6e4,board=document.getElementById("board"),preview=document.getElementById("targetPreview"),statusText=document.getElementById("statusText"),timerText=document.getElementById("timerText"),newBtn=document.getElementById("newBtn"),resetBtn=document.getElementById("resetBtn"),titleScreen=document.getElementById("titleScreen"),resultScreen=document.getElementById("resultScreen"),resultText=document.getElementById("resultText"),startBtn=document.getElementById("startBtn"),toTitleBtn=document.getElementById("toTitleBtn"),boardWrap=document.getElementById("boardWrap"),scoreRegBtn=document.getElementById("scoreRegBtn"),scoreModal=document.getElementById("scoreModal"),submitScoreBtn=document.getElementById("submitScoreBtn"),closeScoreModalBtn=document.getElementById("closeScoreModalBtn"),regName=document.getElementById("regName"),regID=document.getElementById("regID"),rankingScreen=document.getElementById("rankingScreen"),rankingBtn=document.getElementById("rankingBtn"),rankingCloseBtn=document.getElementById("rankingCloseBtn"),loadScreen=document.getElementById("loadScreen");rankingBtn.addEventListener("click",()=>{titleScreen.classList.remove("show"),rankingScreen.classList.add("show")}),rankingCloseBtn.addEventListener("click",()=>{titleScreen.classList.add("show"),rankingScreen.classList.remove("show")});for(let c=0;c<5;c++){let e=document.createElement("button");e.className="ctrl",e.type="button",e.dataset.type="col",e.dataset.index=String(c),e.setAttribute("aria-label",`列 ${c+1} を操作`),e.style.gridColumn=c+2,e.style.gridRow=1,board.appendChild(e)}for(let r=0;r<5;r++){let t=document.createElement("button");t.className="ctrl",t.type="button",t.dataset.type="row",t.dataset.index=String(r),t.setAttribute("aria-label",`行 ${r+1} を操作`),t.style.gridColumn=1,t.style.gridRow=r+2,board.appendChild(t);for(let n=0;n<5;n++){let a=document.createElement("div");a.className="tile",a.dataset.row=String(r),a.dataset.col=String(n),a.style.gridColumn=n+2,a.style.gridRow=r+2,board.appendChild(a)}}let colormode=1,lastTarget=null,targetMatrix=Array.from({length:5},()=>[,,,,,].fill(!1)),inSession=!1,clearedCurrent=!1,solvedCount=0,timerId=null,endTime=0;function paintRow(e,t){board.querySelectorAll(`.tile[data-row="${e}"]`).forEach(e=>{0==t?(e.classList.toggle("black",!1),e.classList.toggle("red",!1)):1==t?(e.classList.toggle("black",!0),e.classList.toggle("red",!1)):2==t&&(e.classList.toggle("black",!1),e.classList.toggle("red",!0))})}function paintCol(e,t){board.querySelectorAll(`.tile[data-col="${e}"]`).forEach(e=>{0==t?(e.classList.toggle("black",!1),e.classList.toggle("red",!1)):1==t?(e.classList.toggle("black",!0),e.classList.toggle("red",!1)):2==t&&(e.classList.toggle("black",!1),e.classList.toggle("red",!0))})}function getBoardState(){let e=Array.from({length:5},()=>[,,,,,].fill(0));return board.querySelectorAll(".tile").forEach(t=>{let n=Number(t.dataset.row),a=Number(t.dataset.col);t.classList.contains("black")?e[n][a]=1:t.classList.contains("red")?e[n][a]=2:e[n][a]=0}),e}function sameMatrix(e,t){for(let n=0;n<5;n++)for(let a=0;a<5;a++)if(e[n][a]!==t[n][a])return!1;return!0}function renderTargetPreview(){preview.innerHTML="";for(let e=0;e<5;e++)for(let t=0;t<5;t++){let n=document.createElement("div");1==targetMatrix[e][t]?n.className="mini-tile black":2==targetMatrix[e][t]?n.className="mini-tile red":n.className="mini-tile",preview.appendChild(n)}}function boardAllWhite(){board.querySelectorAll(".tile").forEach(e=>e.classList.remove("black")),board.querySelectorAll(".tile").forEach(e=>e.classList.remove("red")),color=1,lastTarget=null,boardWrap.classList.remove("cleared"),resetBtn.disabled=!1,board.querySelectorAll(".ctrl").forEach(e=>e.disabled=!1)}function ensureNonTrivial(e){let t=0;for(let n=0;n<5;n++)for(let a=0;a<5;a++)0!=e[n][a]&&t++;if(0===t){let l=Math.floor(5*Math.random());for(let s=0;s<5;s++)e[l][s]=1}}function generateReachableTarget(){let e=Array.from({length:5},()=>[,,,,,].fill(0)),t=0;t=solvedCount<5?5:solvedCount<10?10:solvedCount<20?30:100;for(let n=0;n<t;n++){let a=.5>Math.random()?"row":"col",l=Math.floor(3*Math.random()),s=Math.floor(5*Math.random());if("row"===a)for(let o=0;o<5;o++)e[s][o]=l;else for(let i=0;i<5;i++)e[i][s]=l}ensureNonTrivial(e),targetMatrix=e,renderTargetPreview(),newBtn.disabled=!0,clearedCurrent=!1}function updateTimerDisplay(e){timerText.textContent=`${(Math.max(0,e)/1e3).toFixed(1)}`}function startTimer(){let e=6e4;e=solvedCount<5?6e4:solvedCount<10?5e4:solvedCount<20?4e4:solvedCount<30?3e4:25e3,endTime=Date.now()+e,updateTimerDisplay(e),timerId&&clearInterval(timerId),timerId=setInterval(()=>{let e=Date.now(),t=endTime-e;updateTimerDisplay(t),t<=0&&(clearInterval(timerId),timerId=null,onTimeUp())},100)}function stopTimer(){timerId&&(clearInterval(timerId),timerId=null)}function triggerClearEffect(){boardWrap.classList.add("is-cleared"),setTimeout(()=>{boardWrap.classList.remove("is-cleared")},1e3)}function checkWin(){if(!inSession)return;let e=sameMatrix(getBoardState(),targetMatrix);e&&(clearedCurrent||(solvedCount+=1,clearedCurrent=!0,stopTimer(),hSess()),triggerClearEffect(),statusText.textContent=`SCORE: ${10*solvedCount}`,boardWrap.classList.add("cleared"),newBtn.disabled=!1,resetBtn.disabled=!0,board.querySelectorAll(".ctrl").forEach(e=>e.disabled=!0))}function onTimeUp(){inSession=!1,newBtn.disabled=!0,resultText.textContent=`SCORE: ${10*solvedCount}`,resultScreen.classList.add("show"),resultScreen.removeAttribute("aria-hidden"),scoreRegBtn.disabled=!1;let e=document.getElementById("tweetBtn"),t=encodeURIComponent(`I scored ${10*solvedCount} points in #25TILES https://jkoizumi144.com/25tiles/`),n=`https://twitter.com/intent/tweet?text=${t}`;e.onclick=()=>window.open(n,"_blank","noopener,noreferrer")}function startSession(){solvedCount=0,inSession=!0,statusText.textContent="SCORE: 0",boardAllWhite(),generateReachableTarget(),startTimer()}function endSessionToTitle(){inSession=!1,stopTimer(),newBtn.disabled=!0,updateTimerDisplay(6e4),targetMatrix=Array.from({length:5},()=>[,,,,,].fill(!1)),renderTargetPreview(),boardAllWhite(),statusText.textContent="SCORE: 0"}function openScoreModal(){resultScreen.classList.remove("show"),scoreModal.classList.add("show"),updateSubmitButtonState()}function closeScoreModal(){resultScreen.classList.add("show"),scoreModal.classList.remove("show")}async function userIdFrom(e){let t=new TextEncoder().encode(`${e}`),n=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(n)].map(e=>e.toString(16).padStart(2,"0")).join("")}function updateSubmitButtonState(){let e=regName.value.trim().length>0,t=regID.value.trim().length>0;submitScoreBtn.disabled=!(e&&t)}board.addEventListener("click",e=>{let t=e.target.closest(".ctrl");if(!t||!inSession)return;let n=t.dataset.type,a=Number(t.dataset.index);lastTarget&&lastTarget.type===n&&lastTarget.index===a?colormode=(colormode+1)%3:(colormode=1,lastTarget={type:n,index:a}),"row"===n?paintRow(a,colormode):paintCol(a,colormode),checkWin()}),resetBtn.addEventListener("click",()=>{inSession&&(boardAllWhite(),checkWin())}),newBtn.addEventListener("click",()=>{inSession&&!newBtn.disabled&&(boardAllWhite(),generateReachableTarget(),startTimer())}),startBtn.addEventListener("click",async()=>{titleScreen.classList.remove("show"),loadScreen.classList.add("show"),await sGSess(),loadScreen.classList.remove("show"),startSession()}),toTitleBtn.addEventListener("click",()=>{resultScreen.classList.remove("show"),titleScreen.classList.add("show"),endSessionToTitle()}),scoreRegBtn.addEventListener("click",()=>{openScoreModal()}),closeScoreModalBtn.addEventListener("click",closeScoreModal),submitScoreBtn.addEventListener("click",async()=>{let e=document.getElementById("regName").value.trim(),t=document.getElementById("regID").value,n=await userIdFrom(t);submitScore(n,e),closeScoreModal(),scoreRegBtn.disabled=!0}),regName.addEventListener("input",updateSubmitButtonState),regID.addEventListener("input",updateSubmitButtonState);const API_URL="https://script.google.com/macros/s/AKfycbxPg6JtRLwVKhVZNJWC9036Kg4UOWcq-F0bRdjaUv_dIF2TBDKLK0cXxq1VHQhz7OnM_g/exec";let currentSessionId=null;async function sGSess(){let e=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"start"})});if(!e.ok)throw Error("startSession failed");let t=await e.json();return currentSessionId=t.sessionId,t}async function hSess(){if(!currentSessionId)throw Error("no active session");let e=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"hit",sessionId:currentSessionId})});if(!e.ok)throw Error("hSess failed");let t=await e.json();return t}async function submitScore(e,t){if(!currentSessionId)throw Error("no active session");let n={action:"submit",sessionId:currentSessionId,userId:e,name:t},a=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(n)});if(!a.ok)throw Error("submitScore failed");let l=await a.json();return fetchLeaderboard(),l}async function fetchLeaderboard(){try{let e=await fetch(API_URL);if(!e.ok)throw Error("HTTP error "+e.status);let t=await e.json();renderLeaderboard(t.rows.slice(0,20))}catch(n){console.error(n),document.getElementById("leaderboardList").innerHTML="<li>ランキングを取得できませんでした</li>"}}function renderLeaderboard(e){let t=document.querySelector("#leaderboardTable tbody");t.innerHTML="",e.forEach((e,n)=>{let a=document.createElement("tr"),l=document.createElement("td");l.textContent=`${n+1}`,a.appendChild(l);let s=document.createElement("td");s.textContent=e.name,a.appendChild(s);let o=document.createElement("td");o.textContent=10*e.max,a.appendChild(o),t.appendChild(a)})}window.addEventListener("load",fetchLeaderboard),inSession=!1,newBtn.disabled=!0,updateTimerDisplay(6e4),renderTargetPreview();
})();
</script>
</body>
</html>